spec:
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: update-jira
        image: alpine:latest  # Replace "bitnami/kubectl:latest"
        command: ["/bin/sh", "-c"]
        args:
        - |
          apk add --no-cache curl jq bash  # Install required tools

          echo "üîç Fetching deployed commit SHA from ArgoCD..."
          COMMIT_SHA=$(kubectl get application icecreamflavorrecommendation-app -n argocd -o jsonpath='{.status.sync.revision}')
          echo "‚úÖ Commit SHA: $COMMIT_SHA"

          echo "üîç Fetching commit message from GitHub..."
          COMMIT_MESSAGE=$(curl -s "https://api.github.com/repos/lg0m3s/icecreamflavorrecomendation/commits/$COMMIT_SHA" | jq -r '.commit.message')
          echo "‚úÖ Commit Message: $COMMIT_MESSAGE"

          echo "üîç Extracting Jira ticket from commit message..."
          JIRA_TICKET=$(echo "$COMMIT_MESSAGE" | grep -oE '(^|[^A-Z])([0-9]+|DPLY-[0-9]+)')
          JIRA_TICKET=$(echo "$JIRA_TICKET" | sed 's/^[^A-Za-z0-9]*//')

          echo "‚úÖ Extracted Jira Ticket: $JIRA_TICKET"

          echo "üîç Fetching latest deployed pod's creationTimestamp..."
          POD_TIMESTAMP=$(kubectl get pods -n default -l app=icecreamflavorrecommendation-app --sort-by=.metadata.creationTimestamp -o jsonpath='{.items[-1].metadata.creationTimestamp}')
          echo "‚úÖ Pod Creation Timestamp: $POD_TIMESTAMP"

          if [ -z "$JIRA_TICKET" ]; then
            echo "‚ö†Ô∏è No Jira ticket found in commit message. Skipping Jira update."
            exit 0
          fi

          echo "üöÄ Would now update Jira at: https://devops.atlassian.net/rest/api/3/issue/$JIRA_TICKET"
          echo "üîπ Data that would be sent:"
          echo "{\"fields\":{\"customfield_10489\":\"$POD_TIMESTAMP\"}}"
