apiVersion: batch/v1
kind: Job
metadata:
  name: update-jira-ticket
  namespace: argocd
  annotations:
    argocd.argoproj.io/hook: PostSync  # Runs after a successful deployment
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: update-jira
        image: bitnami/kubectl:latest  # Lightweight image with curl + jq
        command: ["/bin/sh", "-c"]
        args:
        - |
          echo "ğŸ” Fetching deployed commit SHA from ArgoCD..."
          COMMIT_SHA=$(kubectl get application icecreamflavorrecommendation-app -n argocd -o jsonpath='{.status.sync.revision}')
          echo "âœ… Commit SHA: $COMMIT_SHA"

          echo "ğŸ” Fetching commit message from GitHub..."
          COMMIT_MESSAGE=$(curl -s "https://api.github.com/repos/lg0m3s/icecreamflavorrecomendation/commits/$COMMIT_SHA" | jq -r '.commit.message')
          echo "âœ… Commit Message: $COMMIT_MESSAGE"

          echo "ğŸ” Extracting Jira ticket from commit message..."
          JIRA_TICKET=$(echo "$COMMIT_MESSAGE" | grep -oE '[A-Z]+-[0-9]+')
          echo "âœ… Extracted Jira Ticket: $JIRA_TICKET"

          echo "ğŸ” Fetching latest deployed pod's creationTimestamp..."
          POD_TIMESTAMP=$(kubectl get pods -n default -l app=icecreamflavorrecommendation-app --sort-by=.metadata.creationTimestamp -o jsonpath='{.items[-1].metadata.creationTimestamp}')
          echo "âœ… Pod Creation Timestamp: $POD_TIMESTAMP"

          # Exit if no Jira ticket is found to prevent unnecessary API calls
          if [ -z "$JIRA_TICKET" ]; then
            echo "âš ï¸ No Jira ticket found in commit message. Skipping Jira update."
            exit 0
          fi

          echo "ğŸš€ Would now update Jira at: https://devops.atlassian.net/rest/api/3/issue/$JIRA_TICKET"
          echo "ğŸ”¹ Data that would be sent:"
          echo "{\"fields\":{\"customfield_10489\":\"$POD_TIMESTAMP\"}}"

          echo "âœ… Debugging complete. Comment out 'exit 0' below to enable Jira updates."

          exit 0  # ğŸš€ Comment this line out to actually update Jira!
