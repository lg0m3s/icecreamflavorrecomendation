apiVersion: batch/v1
kind: Job
metadata:
  generateName: update-jira-ticket-  
  namespace: argocd
  annotations:
    argocd.argoproj.io/hook: PostSync  
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation  # Removes old job before creating a new one
spec:
  ttlSecondsAfterFinished: 300  # Deletes the job after 5 minutes
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: update-jira
        image: bitnami/kubectl:latest
        command: ["/bin/sh", "-c"]
        args:
        - |
          # Install required tools (lightweight)
          apk add --no-cache curl jq bash

          echo "üîç Fetching deployed commit SHA from ArgoCD..."
          COMMIT_SHA=$(kubectl get application icecreamflavorrecommendation-app -n argocd -o jsonpath='{.status.sync.revision}')
          echo "‚úÖ Commit SHA: $COMMIT_SHA"

          echo "üîç Fetching commit message from GitHub..."
          COMMIT_MESSAGE=$(curl -s "https://api.github.com/repos/lg0m3s/icecreamflavorrecomendation/commits/$COMMIT_SHA" | jq -r '.commit.message')
          echo "‚úÖ Commit Message: $COMMIT_MESSAGE"

          echo "üîç Extracting Jira ticket from commit message..."
          JIRA_TICKET=$(echo "$COMMIT_MESSAGE" | grep -oE '(^|[^A-Z])([0-9]+|DPLY-[0-9]+)')
          JIRA_TICKET=$(echo "$JIRA_TICKET" | sed 's/^[^A-Za-z0-9]*//')

          echo "‚úÖ Extracted Jira Ticket: $JIRA_TICKET"

          echo "üîç Fetching latest deployed pod's creationTimestamp..."
          POD_TIMESTAMP=$(kubectl get pods -n default -l app=icecreamflavorrecommendation-app --sort-by=.metadata.creationTimestamp -o jsonpath='{.items[-1].metadata.creationTimestamp}')
          echo "‚úÖ Pod Creation Timestamp: $POD_TIMESTAMP"

          if [ -z "$JIRA_TICKET" ]; then
            echo "‚ö†Ô∏è No Jira ticket found in commit message. Skipping Jira update."
            exit 0
          fi

          echo "‚úÖ Jira update complete!"
